<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working on Gloomhaven Enhanced :: Gloomhaven Enhanced</title>
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../_/css/site.css">
    <link rel="stylesheet" href="../_/css/gh-site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="..">Gloomhaven Enhanced</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="dev" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Development</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="build.html">Working on GHE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="documentation.html">Documentation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="commandLine.html">Command Line</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Engine</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="engine/campaignManager.html">Campaign Manager</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Frosthaven</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="frosthaven/campaignManager.html">Campaign Manager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="frosthaven/sourceOfTruth.html">Sources of Truth</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Gloomhaven</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gloomhaven/campaignManager.html">Campaign Manager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gloomhaven/sourceOfTruth.html">Sources of Truth</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Development</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../creator/index.html">Content Creator</a></div>
    </li>
    <li class="component">
      <div class="title"><a href="../custom/latest/index.html">Custom Content</a></div>
      <ul class="versions">
        <li class="version">
          <a href="../custom/next/index.html">2-beta</a>
        </li>
        <li class="version is-latest">
          <a href="../custom/latest/index.html">1.3</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="index.html">Development</a></div>
    </li>
    <li class="component">
      <div class="title"><a href="../mod/latest/index.html">Gloomhaven Enhanced</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../mod/latest/index.html">2</a>
        </li>
        <li class="version">
          <a href="../mod/1.3/index.html">1.3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Development</a></li>
    <li><a href="build.html">Working on GHE</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/gloomhaven-tts-enhanced/public-scripts/edit/main/docs/content/development/modules/ROOT/pages/build.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Working on Gloomhaven Enhanced</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Gloomhaven Enhanced (GHE) is split into different mods that support each other.
There&#8217;s a base mod called "Enginehaven" that contains the basic engine of the mod.
So all the scripts for the scenario engine, the round tracking, campaign manager, etc.
It doesn&#8217;t contain any actual content, like scenarios, classes or items.
Those are added from other mods, so-called content boxes.</p>
</div>
<div class="paragraph">
<p>Each actual game (Gloomhaven, Frosthaven, Crimson Scales, etc.) is a separate mod that contains such a content box.
The box then contains the actual game components for that specific game.
Loading the content box into Enginehaven analyzes and unpacks its content into the places where the engine needs them, so the game can be used.</p>
</div>
<div class="paragraph">
<p>The current state of each mod is stored in a directory inside the <code>mods</code> directory of the repository.
A mod in TTS is a JSON file that contains the data of each object in the game, which includes it scripts and content for things like bags and decks.
The repository doesn&#8217;t store the complete JSON file though.
Instead, the JSON file is split into a directory structure, where each object in the mod has its own files that only contains the data for this specific object.
This makes it easier to track and update individual objects.
It also makes sure that saved data is smaller than it would be in a complete save file.</p>
</div>
<div class="paragraph">
<p>In the complete save file each object would contain its complete script.
Since many objects use the <code>require()</code> syntax to load a specific script, which in turn typically also <code>require</code>s other scripts, TTS needs, a complete, bundled version of the script where each <code>require</code> is replaced with the actual script content.
This would lead to lots of redundant scripts.
Instead, for each object only the top-level script is saved.</p>
</div>
<div class="paragraph">
<p>The complete save file that can then be used in TTS can be recreated from this file structure, using a specific tool.
To get this tool working, some setup needs to be done first.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Having git installed and a clone of the <code>enhanced</code> repository is already assumed.</p>
</li>
<li>
<p>Install <a href="https://nodejs.org/en/download/package-manager/">node.js</a>.
This is a tool that can execute JavaScript code on your machine without a browser.
The tools mentioned above a written in JavaScript (or TypeScript to be more precise) and need node.js to run.</p>
</li>
<li>
<p>Install <a href="https://pnpm.io/installation">pnpm</a>.
This is a package manager for node.js tools that manages dependencies the tools require.</p>
</li>
<li>
<p>Run <code>pnpm install</code> from the root directory of the mod.
This will download all dependencies that the tools need in order to run</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_the_mods"><a class="anchor" href="#_building_the_mods"></a>Building the mods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to build the working mods from the files in the repository,</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repository_structure"><a class="anchor" href="#_repository_structure"></a>Repository structure</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>imports</code></dt>
<dd>
<p>This directory contains all the scripts and XML files that are used in the various mods.</p>
</dd>
<dt class="hdlist1"><code>mods</code></dt>
<dd>
<p>This directory contains the different mods that we release.
Each mod directory contains the extracted mod content inside a <code>content</code> directory.
It also contains a <code>package.json</code>, where the scripts are defined that can be run to extract/embed/build and release that mod.
Finally, there&#8217;s a <code>.ttsrc</code> file.
This is a config file that defines the workshop item ids that are used for this mod.
It&#8217;s used to upload the mod to the Steam workshop via a script.</p>
</dd>
<dt class="hdlist1"><code>tools</code></dt>
<dd>
<p>Contains various tools used. For now this should contain the <code>kpsteam</code> tool to easily upload files to the Steam workshop.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_workflow"><a class="anchor" href="#_basic_workflow"></a>Basic workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whenever there are physical changes on the mod (e.g. adding new object, moving or deleting existing ones, etc.) the mod has to be extracted.
This will read the mod&#8217;s save file and put its data into this repository by splitting it into multiple files.</p>
</div>
<div class="paragraph">
<p>When the scripts are changed, a previously extracted save file can be embedded again.
This will stitch the split files back together and update the script with the ones currently in the <code>imports</code> directory for all objects, even the ones in containers.</p>
</div>
<div class="paragraph">
<p>If a mod is ready for release (either the main version, a beta version, or simply the current development version), it can be build and uploaded to the Steam workshop, all without starting TTS itself (Steam with the correct account needs to run, though).</p>
</div>
<div class="paragraph">
<p>The following sections describe the different commands in more detail.
The commands are typically run from the mod&#8217;s directory.
However, they can also be run from the root directory.
Check the <code>package.json</code> file in the root directory for possible aliases, e.g. <code>embed:ghe</code> will embed the GHE mod.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extracting_a_mod"><a class="anchor" href="#_extracting_a_mod"></a>Extracting a mod</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the command <code>pnpm extract</code> from the mod directory.
This will find the save file for this mod on your local TTS save file directory and extract its content.
The name of the save file that is looked for is defined inside the <code>.ttsrc</code> file of this mod.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_embedding_a_mod"><a class="anchor" href="#_embedding_a_mod"></a>Embedding a mod</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the command <code>pnpm embed</code> from the mod directory.
This will embed a previously extracted save file again and update its scripts with the current versions from <code>imports</code>.
It will write the embedded save file to your TTS save file directory if there&#8217;s already as save file with the targeted name.
If not, it will write the save file to the root directory of the mod.
The name of the save file that is looked for is defined inside the <code>.ttsrc</code> file of this mod.</p>
</div>
<div class="paragraph">
<p>The embedded save file will also be written to <code>dist/Save.json</code>.
The command also creates a releasable file inside the <code>dist</code> directory of the mod called <code>Save.bson</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_releasing_a_mod"><a class="anchor" href="#_releasing_a_mod"></a>Releasing a mod</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To automatically upload the build save file, run the command <code>pnpm release [environment]</code>.
Environment defines the target workshop item (e.g. <code>dev</code>, <code>beta</code> or <code>prod</code>).
If the parameter is omitted, <code>dev</code> will be the default.
Which environments are available and wich workshop id is associated with it, can be found in the <code>.ttsrc</code> file within the mod directory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_new_mods"><a class="anchor" href="#_adding_new_mods"></a>Adding new mods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To add a new mod that can be extracted, embedded and releases, add a new directory inside the <code>mods</code> directory.
The name should be all lowercase and spaces should be replaced with hyphens.
Copy fhe <code>package.json</code>, <code>.ttsrc</code> and <code>.gitignore</code> files from another mod into the new directory.</p>
</div>
<div class="paragraph">
<p>Inside the <code>package.json</code>, change the <code>name</code> attribute to reflect the name of the mod directory (prefixed with <code>mod</code>, e.g. <code>mod-ghe</code>).
You can also update the <code>description</code> field, though it&#8217;s currently not used.</p>
</div>
<div class="paragraph">
<p>Inside the <code>.ttsrc</code> file, change the ids for the different workshop mod versions.
You can add as many as you want and delete existing ones. but at least <code>prod</code> and <code>dev</code> should exist, where <code>prod</code> is the main mod and <code>dev</code> is the current development build.
A <code>beta</code> version would also be useful for the open beta version of this mod.</p>
</div>
<div class="paragraph">
<p>To make the command executable from the root directory, also modify the <code>package.json</code> in the root directory.
Copy the lines of existing aliases.
Replace the part after the colon with the new alias and the part after the <code>-F</code> with the name of the mod that was set as the <code>name</code> inside its <code>package.json</code>.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="200" data-stylesheet="../_/css/search.css"></script>
<script async src="../search-index.js"></script>
  </body>
</html>
